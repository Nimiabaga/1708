<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin — 1708 | Price Editor</title>
  <meta name="robots" content="noindex,nofollow"/>

  <style>
    :root{
      /* slightly smaller */
      --text:#f2f2f2; --muted:#bdbdbd; --gold:#d4af37;
      --card: rgba(255,255,255,.05); --card2: rgba(255,255,255,.03);
      --bd: rgba(255,255,255,.12);
      --fs: clamp(.92rem, 1.5vw, .98rem);
      --fs-small: clamp(.82rem, 1.3vw, .92rem);
      --fs-title: clamp(1.28rem, 3.0vw, 1.58rem);
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#0b0b0b; color:var(--text);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .wrap{ max-width:980px; margin:22px auto 36px; padding:0 12px; }
    h1{
      margin:6px 0 14px; text-align:center; letter-spacing:.22em; text-transform:uppercase;
      color:#ffdf7a; font-size:var(--fs-title); text-shadow:0 0 22px rgba(255,223,122,.25);
    }
    .back{ color:#ffdf7a; text-decoration:none; display:inline-flex; align-items:center; gap:.45rem; margin:.2rem 0 1rem; }
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--bd); border-radius:16px; padding:14px;
      box-shadow:0 14px 28px rgba(0,0,0,.55);
    }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .toolbar input[type="search"], .toolbar select{
      background:#111; color:#fff; border:1px solid #2c2c2c; border-radius:10px; padding:10px 12px; font-size:var(--fs);
    }
    .btn{ appearance:none; border:0; border-radius:999px; padding:9px 14px; font-weight:900; cursor:pointer;
          background:linear-gradient(180deg,#fff,#e9e9e9); color:#111; font-size:var(--fs); }
    .btn.secondary{ background:#222; color:#f5f5f5; border:1px solid #2f2f2f; }
    .btn.danger{ background:#c1121f; color:#fff; }
    .status{ margin-left:auto; color:var(--muted); white-space:nowrap; font-size:var(--fs-small); }

    table{ width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:10px; font-size:var(--fs); }
    thead th{ color:#ddd; font-size:.9em; letter-spacing:.06em; text-transform:uppercase; }
    th, td{ text-align:left; padding:10px 12px; }
    tbody tr{ background:rgba(255,255,255,.035); border:1px solid rgba(255,255,255,.10); }
    tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px; }
    tbody tr td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px; }

    select.type, input.cat, input.price, select.item-select{
      width:100%; background:#0e0e0e; color:#fff; border:1px solid #444; border-radius:8px; padding:8px 10px;
    }
    input.price{ text-align:right; max-width:140px; }
    .check{ width:18px; height:18px; }
    .del{ padding:8px 12px; border-radius:10px; }

    @media (max-width:600px){
      .btn{ width:100%; justify-content:center }
      .toolbar{ gap:10px }
      .status{ width:100%; text-align:center; margin:6px 0 0 }
      table{ font-size:.95rem }
      input.price{ max-width:100% }
    }
    @media (prefers-reduced-motion:reduce){ .btn, .card{ transition:none !important } }
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="admin.html">← Back to admin</a>
    <h1>PRICE EDITOR</h1>

    <div class="card">
      <div class="toolbar">
        <input id="search" type="search" placeholder="Search item or category...">
        <select id="show">
          <option value="">Show: All</option>
          <option value="Drinks">Drinks</option>
          <option value="Food">Food</option>
          <option value="Rooms">Rooms</option>
        </select>

        <button id="add" class="btn">Add Item</button>
        <button id="save" class="btn">Save</button>
        <button id="download" class="btn">Download JSON</button>
        <label class="btn secondary">
          Load JSON <input id="upload" type="file" accept="application/json" style="display:none">
        </label>
        <button id="startfresh" class="btn danger">Start fresh (2 rows)</button>

        <span id="status" class="status"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Item (choose from dropdown)</th>
            <th>Cat</th>
            <th>Price (₦)</th>
            <th>Available</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    /* ===== BACKEND CONFIG ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbw5v7gImXthxWkHUaCtDdDGx4U_tts7_1JWuHA9ojyu6nm2qvHyPehZrtfEK2j5JTMy/exec';
    const TOKEN   = 'Forgive1988@';

    /* ===== 1708 CATALOG ===== */
    const drinksCatalog = {
      "Arabian Tea": [
        { name: "Abino Shaka", price: 7000 },
        { name: "Man Power", price: 7000 },
        { name: "Body Cleanser", price: 7000 }
      ],
      "Beers/Lagers": [
        { name: "Star", price: 1800 },
        { name: "Gulder", price: 1900 },
        { name: "Heineken", price: 2100 },
        { name: "Medium Heineken", price: 1600 },
        { name: '33"', price: 1600 },   // fixed data literal is okay now
        { name: "Budweisser", price: 3000 },
        { name: "Life", price: 1600 },
        { name: "Trophy", price: 1600 },
        { name: "Hero", price: 1600 },
        { name: "Tiger", price: 1600 }
      ],

      "Beers/Stout": [
        { name: "Small Stout", price: 1700 },
        { name: "Medium Stout", price: 2000 },
        { name: "Big Stout", price: 2700 },
        { name: "Legend", price: 2000 },
        { name: "Guinness Smooth", price: 2500 }
      ],
      "Beers/Ready": [
        { name: "Star Radler", price: 1300 },
        { name: "Orijin", price: 1700 },
        { name: "Smirnoff (big)", price: 2200 },
        { name: "Smirnoff (small)", price: 1200 },
        { name: "Flying Fish", price: 1500 },
        { name: "Medium Smirnoff Double Black", price: 1600 },
        
         { name: "Castle Lite", price: 1500 },
        { name: "Desperadoes", price: 1800 }
      ],
      "Soft/Mixer": [
        { name: "Maltina", price: 1200 },
        { name: "Amstel", price: 1200 },
        { name: "Guinness Malta", price: 1200 },
        { name: "Water", price: 500 },
        { name: "Fayrouz", price: 1000 },
        { name: "Coke can", price: 1000 },
        { name: "Mineral", price: 1000 },
        { name: "Cranberry", price: 3200 },
        { name: "Juice", price: 3000 },
        { name: "Hollandia", price: 3500 },
        { name: "Chivita Active", price: 100 },
        { name: "Chivita 100", price: 4300 },
        { name: "Peak Yogurt", price: 4000 },
        { name: "Vita Milk", price: 1700 }
      ],
      "Energy/Herbs": [
        { name: "Blue Bullet", price: 2000 },
        { name: "Red Bull", price: 3000 },
        { name: "Black Bullet", price: 3000 },
        { name: "Fearless", price: 1000 },
        { name: "Predator", price: 2000 },
        { name: "Climax Can", price: 1200 },
        { name: "Origin Bitters", price: 2500 },
        { name: "Odogwu Bitters", price: 1200 },
        { name: "Ace Bitters", price: 1700 },
        { name: "Zagg", price: 1100 },
        { name: "Chapman ALC", price: 2200 },
        { name: "Vinogano", price: 1700 },
        { name: "Don Simon", price: 6500 },
        { name: "1960", price: 1700 }
      ],
      "Accessories": [
        { name: "Lighter", price: 300 }
      ],
      "Cigarettes": [
        { name: "Dunhill", price: 3200 },
        { name: "Benson Switch", price: 3000 },
        { name: "Benson Boost", price: 2000 },
        { name: "Benson", price: 2400 },
        { name: "Esse Change", price: 3400 }
      ],
      "Cigarettes/Nuts": [
        { name: "Oris", price: 2000 },
        { name: "Chesterfield", price: 3100 },
        { name: "Dorchester", price: 3100 },
        { name: "Bohem", price: 2100 },
        { name: "Groundnut Small", price: 1800 },
        { name: "Groundnut Big", price: 5050 }
      ],
      "Cocktails": [
  { "name": "Adios Motherfucker", "price": 10000 },
  { "name": "Tequila Sunrise", "price": 10000 },
  { "name": "Screaming Orgasm", "price": 10000 },
  { "name": "Strawberry Daiquiri", "price": 10000 },
  { "name": "Sweet Poison", "price": 10000 },
  { "name": "Zombie", "price": 10000 },
  { "name": "Irish Coffee", "price": 10000 },
  { "name": "Frozen Strawberry Margarita", "price": 10000 },
  { "name": "Frozen Blue Margarita", "price": 10000 },
  { "name": "Classic Margarita", "price": 10000 },
  { "name": "Long Island Iced Tea", "price": 10000 },
  { "name": "Electric Ice Tea", "price": 10000 },
  { "name": "Kiwi Fizzy", "price": 10000 },
  { "name": "Mai Tai", "price": 10000 },
  { "name": "Blue Hawaii", "price": 10000 },
  { "name": "Mojito", "price": 10000 },
  { "name": "Piña Colada", "price": 10000 },
  { "name": "Long-island", "price": 10000 },
  { "name": "Sex on the Beach", "price": 10000 },
  { "name": "Hammer", "price": 10000 }
],

      "Liquor": [
        { name: "Gordon Gin (Medium)", price: 5000 },
        { name: "Big Gordon", price: 12000 },
        { name: "Smirnoff X1 (Small)", price: 3200 },
        { name: "Smirnoff X1 (Big)", price: 12000 },
        { name: "Kensington", price: 13000 },
        { name: "John Bannermans", price: 25000 },
        { name: "M/Campari", price: 32000 },
        { name: "B/Campari", price: 36000 },
        { name: "Clay More", price: 14000 },
        { name: "Monkey Shoulder", price: 45000 },
        { name: "Baileys", price: 35000 }
      ],
      "Milkshakes": [
  { "name": "Creamy Vanilla" },
  { "name": "Strawberry Slush" },
  { "name": "Peanut Butter Delight" },
  { "name": "Chocolate Flavoured Shakes" },
  { "name": "Bailey Milkshake" },
  { "name": "Banana Milkshake" },
  { "name": "Sneakers Milkshake" }
],     "Mocktails": [
  { "name": "Chapman", "price": 6000 },
  { "name": "Tropical Island", "price": 8000 },
  { "name": "Bribe Pina", "price": 8000 },
  { "name": "Frozen Passion Colada", "price": 8000 },
  { "name": "Blue Lemonade", "price": 8000 },
  { "name": "Blue Hawaii", "price": 8000 },
  { "name": "Sweet Sunrise", "price": 8000 },
  { "name": "Lick Me Up", "price": 8000 },
  { "name": "Cucumber Cooler", "price": 8000 },
  { "name": "Bahamas Sunrise", "price": 8000 },
  { "name": "Cinderella", "price": 8000 },
  { "name": "Ginger Lemonade", "price": 8000 }
],
      
      "Shots": [
  { name: "Tequila", price: 3000 },
  { name: "Casamigos Tequila", price: 3000 },
  { name: "Bacardi", price: 3000 },
  { name: "Campari", price: 3000 },
  { name: "Baileys", price: 3000 },
  { name: "Gin", price: 3000 },
  { name: "Jagermeister", price: 3000 }
],



     "Smoothies": [
  { "name": "Milk Fruity", "price": 8000 },
  { "name": "Banana Strawberry", "price": 8000 },
  { "name": "Avocado Banana", "price": 8000 },
  { "name": "Peanut Banana", "price": 8000 },
  { "name": "Ginger Mix", "price": 8000 },
  { "name": "Fresh Juice", "price": 8000 },
  { "name": "Fruit Perfait", "price": 8000 },

  { "name": "Strawberry Banana Smoothie", "price": 8000 },
  { "name": "Tropical Bowl Smoothie", "price": 8000 },
  { "name": "Sex Boster Smoothie", "price": 8000 },
  { "name": "Creamy Avocado Smoothie", "price": 8000 },
  { "name": "Pussy Wet Smoothie", "price": 8000 }
],

      "Whiskey": [
        { name: "Williams Lawson", price: 25000 },
        { name: "Jack Daniels", price: 40000 },
        { name: "American Honey", price: 35000 },
        { name: "Macallan 12yrs", price: 120000 },
        { name: "Williams Lawson Small", price: 12000 },
        { name: "Jameson Green Small", price: 18000 },
        { name: "Jameson Black", price: 67000 },
        { name: "Singleton", price: 80000 },
        { name: "Glenfiddich 12yrs", price: 110000 },
        { name: "Glenfiddich 15yrs", price: 128000 },
        { name: "Glenfiddich 18yrs", price: 184000 },
        { name: "Hennessey VS", price: 106000 },
        { name: "Hennessey VSOP", price: 167000 },
        { name: "Remy Martin", price: 105000 },
        { name: "Swift Martel", price: 134000 },
        { name: "Glenmorangie", price: 73000 },
        { name: "Martel VS", price: 73000 },
        { name: "Monkey Shoulder", price: 45000 },
        { name: "Jameson Green Big", price: 40000 },
        { name: "Black Label", price: 70500 },
        { name: "Jambis", price: 23000 },
        { name: "Tenjaku", price: 45000 }
      ],
      "Wines": [
        { name: "Carlo Rossi", price: 18000 },
        { name: "Markenellis", price: 18000 },
        { name: "Asconi Agor Wine", price: 18000 },
        { name: "Four Cousins", price: 18000 },
        { name: "Four Cousins Sparkling", price: 20000 },
        { name: "Silk and Spice Wine", price: 30000 },
        { name: "Andre", price: 22000 },
        { name: "Drostdy hof", price: 18000 },
        { name: "Pastoral Wine", price: 19000 },
        { name: "Pastoral Muscat", price: 21000 },
        { name: "Pastoral Sour", price: 21500 },
        { name: "Star Chaser", price: 17000 },
        { name: "Lamothe Original", price: 15000 },
        { name: "Toma Wine", price: 10000 },
        { name: "Princi Pinal Wine", price: 10000 },
        { name: "1964 Wine", price: 11000 },
        { name: "Sweet Lip Wine", price: 15000 }
      ]
    };

    const foodCatalog = {
      "Appetizer (Inter-Continental)": [
        { name: "Samosa (5 pieces)", price: 6000 },
        { name: "Springroll (5 pieces)", price: 5500 },
        { name: "Nkwobi", price: 9000 },
        { name: "Isi-Ewu", price: 10000 },
        { name: "Chicken Wings", price: 7000 },
        { name: "Peppered Gizzard", price: 8500 },
        { name: "Peppered Chicken", price: 7500 },
        { name: "Peppered Goat Meat", price: 9000 },
        { name: "Peppered Beef", price: 7000 },
        { name: "Peppered Cow - Tail", price: 8000 },
        { name: "Peppered Cow - Head", price: 8500 },
        { name: "Peppered Snail", price: 4500 },
        { name: "Peppered Croaker", price: 8900 },
        { name: "Peppered Assorted", price: 4800 }
      ],
      "Appetizer (National)": [
        { name: "Chicken Peppersoup", price: 7000 },
        { name: "Goat Meat Peppersoup", price: 8000 },
        { name: "Beef Peppersoup", price: 6000 },
        { name: "Catfish Peppersoup", price: 7000 },
        { name: "Assorted Meats Pepper Soup", price: 8000 },
        { name: "Cow Leg Peppersoup", price: 7000 },
        { name: "Cow Head Peppersoup", price: 8000 }
      ],
      "BBQ & Fries": [
        { name: "Croaker Fish", price: 13400 },
        { name: "Cat Fish", price: 13400 },
        { name: "Barbecue Chicken", price: 5200 },
        { name: "Fries", price: 3000 }
      ],
      "Beverages": [
        { name: "Coffee", price: 2500 },
        { name: "Tea", price: 2000 },
        { name: "Lipton Tea", price: 0 },
        { name: "Custard", price: 0 },
        { name: "Cocoa", price: 2500 }
      ],
      "Breakfast Dishes": [
        { name: "Boiled Plantain", price: 3500 },
        { name: "Fried Plantain", price: 3500 },
        { name: "Fried Yam", price: 3500 },
        { name: "Boiled Yam", price: 3000 },
        { name: "Club Sandwich", price: 6500 },
        { name: "English Breakfast", price: 7500 },
        { name: "Toasted Breads", price: 2500 }
      ],
      "Main Dishes (Inter-Continental)": [
        { name: "Plain Spaghetti",       price: 0 },
        { name: "Jollof Spaghetti",      price: 0 },
        { name: "French Fries",          price: 3500 },
        { name: "Chinese Stir-Fry Rice", price: 0 }
      ],
      "Main Dishes (National)": [
        { name: "Jollof Rice", price: 5500 },
        { name: "White Rice", price: 4500 },
        { name: "Fried Rice", price: 5500 }
      ],
      "National Soups": [
        { name: "Afang Soup", price: 6500 },
        { name: "Okro / Okra Soup", price: 5500 },
        { name: "Egusi Soup", price: 6000 },
        { name: "Vegetable Soup", price: 6000 },
        { name: "Native Soup", price: 6500 },
        { name: "Fisherman Soup", price: 9000 }
      ],
      "Proteins": [
        { name: "Boiled Egg", price: 800 },
        { name: "Omelette", price: 1500 },
        { name: "Beef", price: 2500 },
        { name: "Chicken", price: 3000 },
        { name: "Goat Meat", price: 3200 },
        { name: "Catfish", price: 3500 },
        { name: "Croaker", price: 3800 },
        { name: "Cow Tail", price: 2800 },
        { name: "Cow Head", price: 3000 },
        { name: "Assorted", price: 3700 },
        { name: "Gizzard", price: 6300 },
        { name: "Snail", price: 4700 },
        { name: "Cowleg", price: 4700 }
      ],
      "Stews & Sauces": [
        { name: "Tomatoes Stew", price: 4500 },
        { name: "Tomatoes Sauce", price: 1200 },
        { name: "Peppered Sauce/Soup", price: 1200 },
        { name: "Fried Rice Sauce", price: 1200 },
        { name: "Vegetable Sauce", price: 2300 },
        { name: "Salad", price: 1700 },
        { name: "Curry Sauce", price: 5000 },
        { name: "Egg Sauce", price: 4000 }
      ],
      "Swallows": [
        { name: "Poundo (Yam)", price: 2500 },
        { name: "Semovita", price: 2300 },
        { name: "Garri", price: 2000 },
        { name: "Wheat", price: 2300 }
      ],
      "Takeout": [
        { name: "Takeout", price: 300 }
      ]
    };

    const roomsCatalog = {
      "Rooms": [
        { name: "Deluxe", price: 45000 },
        { name: "Standard", price: 40000 }
      ]
    };

    /* ===== helpers ===== */
    const $ = (id)=>document.getElementById(id);
    const uid = ()=> String(Date.now()) + Math.random().toString(16).slice(2);
    const money = v => (v==null || v==='') ? '' : Number(v);
    const catalogForType = (t)=> t==='Food' ? foodCatalog : t==='Rooms' ? roomsCatalog : drinksCatalog;

    let rows = [];
    let pendingNew = [];
    let saveTimer = null;

    function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveToSheet, 600); // debounce autosave
      $('status').textContent = 'Saving…';
    }

    async function fetchItems(){
      $('status').textContent = 'Loading...';
      const res = await fetch(`${API_URL}?token=${encodeURIComponent(TOKEN)}`);
      const data = await res.json();
      if(!data.ok) throw new Error(data.error||'Failed to load');
      rows = Array.isArray(data.rows) ? data.rows : [];
      pendingNew = [];
      const seeded = seedMissingNewlyAddedRows();
      if (seeded) {
        await saveToSheet({ silent: true });
      }
      render();
      $('status').textContent = seeded
        ? `Loaded ${rows.length} item(s) + synced ${seeded} new item(s).`
        : `Loaded ${rows.length} item(s)`;
    }

    function seedMissingNewlyAddedRows(){
      const key = r => `${String(r.type || '').trim().toLowerCase()}|||${String(r.cat || '').trim().toLowerCase()}|||${String(r.name || '').trim().toLowerCase()}`;
      const existing = new Set(rows.map(key));

      const targets = [
        { type: 'Drinks', cat: 'Whiskey', names: [
          'American Honey','Jameson Black','Glenfiddich 12yrs','Glenfiddich 15yrs','Glenfiddich 18yrs',
          'Hennessey VS','Hennessey VSOP','Remy Martin','Swift Martel','Glenmorangie','Martel VS','Macallan 12yrs'
        ]},
        { type: 'Drinks', cat: 'Liquor', names: ['Clay More'] },
        { type: 'Drinks', cat: 'Energy/Herbs', names: ['Ace Bitters','Zagg','Chapman ALC','Vinogano','1960'] },
        { type: 'Drinks', cat: 'Cigarettes/Nuts', names: ['Groundnut Big'] },
        { type: 'Food', cat: 'Stews & Sauces', names: ['Tomatoes Sauce','Peppered Sauce/Soup','Fried Rice Sauce','Salad','Vegetable Sauce'] },
        { type: 'Food', cat: 'Beverages', names: ['Lipton Tea','Custard'] },
        { type: 'Drinks', cat: 'Soft/Mixer', names: ['Peak Yogurt'] },
        { type: 'Drinks', cat: 'Wines', names: ['Pastoral Sour','1964 Wine','Asconi Agor Wine','Silk and Spice Wine'] }
      ];

      let added = 0;
      targets.forEach(target => {
        const source = target.type === 'Food' ? foodCatalog : target.type === 'Rooms' ? roomsCatalog : drinksCatalog;
        const list = source[target.cat] || [];

        target.names.forEach(name => {
          const k = `${String(target.type).trim().toLowerCase()}|||${String(target.cat).trim().toLowerCase()}|||${String(name).trim().toLowerCase()}`;
          if (existing.has(k)) return;

          const found = list.find(i => String(i?.name || '').trim().toLowerCase() === String(name).trim().toLowerCase());
          pendingNew.push({
            id: uid(),
            type: target.type,
            name,
            cat: target.cat,
            price: Number(found?.price || 0),
            available: true,
            __new: true
          });
          existing.add(k);
          added += 1;
        });
      });

      return added;
    }

    function filtered(){
      const q = $('search').value.trim().toLowerCase();
      const show = $('show').value;
      const all = rows.concat(pendingNew); // include new rows before filtering
      return all.filter(r =>
        (!show || String(r.type)===show) &&
        (!q || String(r.name).toLowerCase().includes(q) || String(r.cat).toLowerCase().includes(q))
      );
    }

    // ---------- FIXED: escape option labels/values so names like 33" work ----------
    function itemSelectHTML(row){
      const esc = s => String(s)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      const norm = s => String(s || '').trim().toLowerCase();

      const cat = catalogForType(row.type || 'Food');
      const groups = Object.keys(cat);
      const rowCat = norm(row.cat);
      const rowName = norm(row.name);
      let hasCurrent = false;

      let html = `<select class="item-select">
        <option value="">— pick item —</option>`;

      if (groups.length){
        for (const g of groups){
          html += `<optgroup label="${esc(g)}">`;
          for (const it of cat[g]){
            const rawVal = `${g}|||${it.name}`;
            const val = esc(rawVal);
            const label = esc(it.name);
            const selected = (rowCat === norm(g) && rowName === norm(it.name)) ? 'selected' : '';
            if (selected) hasCurrent = true;
            html += `<option value="${val}" ${selected}>${label}</option>`;
          }
          html += `</optgroup>`;
        }
      }

      if (!hasCurrent && row.name){
        const currentCat = String(row.cat || '(Custom)').trim();
        const currentName = String(row.name).trim();
        const rawVal = `${currentCat}|||${currentName}`;
        html += `<option value="${esc(rawVal)}" selected>Current: ${esc(currentName)}</option>`;
      }

      html += `<option value="__custom__">— Custom… —</option></select>`;
      return html;
    }
    // ------------------------------------------------------------------------------

    function tr(row, isNew=false){
      const id = row.id;
      return `
        <tr data-id="${id}" ${isNew?'data-new="1"':''}>
          <td>
            <select class="type">
              ${['','Drinks','Food','Rooms'].map(t=>`<option value="${t}" ${String(row.type||'')===t?'selected':''}>${t||'—'}</option>`).join('')}
            </select>
          </td>
          <td>${itemSelectHTML(row)}</td>
          <td><input class="cat"  value="${row.cat??''}"  placeholder="Category"></td>
          <td><input class="price" type="number" min="0" step="1" value="${row.price??''}"></td>
          <td><input class="check avail" type="checkbox" ${row.available?'checked':''}></td>
          <td><button class="del btn secondary">Delete</button></td>
        </tr>`;
    }

    function refreshRowControls(trEl, row){
      trEl.querySelector('td:nth-child(2)').innerHTML = itemSelectHTML(row);
    }

    function render(){
      const body = filtered().map(r => tr(r, !!r.__new)).join('');
      $('tbody').innerHTML = body || '<tr><td colspan="6" style="text-align:center;color:#bbb;">No items</td></tr>';
    }

    // Input handlers (AUTOSAVE)
    document.addEventListener('input', e=>{
      const trEl = e.target.closest('tr'); if(!trEl) return;
      const id = trEl.dataset.id;
      const isNew = trEl.dataset.new === '1';
      const src = isNew ? pendingNew : rows;
      const row = src.find(x=>String(x.id)===String(id));
      if (!row) return;

      if (e.target.classList.contains('type')){
        row.type = e.target.value || '';
        row.name = ''; row.cat = ''; row.price = 0;
        refreshRowControls(trEl, row);
        // Clear visible inputs to match reset data
        trEl.querySelector('.cat').value = '';
        trEl.querySelector('.price').value = '';
        return; // do not autosave on type change
      }
      if (e.target.classList.contains('cat'))  { row.cat  = e.target.value; scheduleSave(); }
      if (e.target.classList.contains('price')){ row.price = money(e.target.value); scheduleSave(); }
      if (e.target.classList.contains('avail')){ row.available = e.target.checked; scheduleSave(); }

      if (e.target.classList.contains('item-select')){
        const val = e.target.value; // browser decodes entities back automatically
        if (val === '__custom__'){
          const nm = prompt('Enter custom item name');
          if (nm){
            row.name = nm; row.cat = '(Custom)';
            trEl.querySelector('.cat').value = row.cat;
            scheduleSave();
          }
          e.target.value = '';
        } else if (val){
          const [cat,name] = val.split('|||');
          row.cat = cat; row.name = name;
          const catMap = catalogForType(row.type || 'Food');
          const found = (catMap[cat]||[]).find(i=>i.name===name);
          row.price = found ? Number(found.price)||0 : row.price;
          trEl.querySelector('.cat').value = row.cat;
          trEl.querySelector('.price').value = row.price || 0;
          scheduleSave();
        } else {
          row.name=''; row.cat='';
          scheduleSave();
        }
      }
    });

    // Delete
    document.addEventListener('click', e=>{
      if(!e.target.classList.contains('del')) return;
      const trEl = e.target.closest('tr'); const id = trEl.dataset.id;
      if (trEl.dataset.new === '1') {
        pendingNew = pendingNew.filter(x=>String(x.id)!==String(id));
      } else {
        const r = rows.find(x=>String(x.id)===String(id));
        if (r){ r.available = false; r.price = 0; }
      }
      render();
      scheduleSave();
    });

    // Add row
    $('add').addEventListener('click', ()=>{
      const id = uid();
      pendingNew.push({ id, type:'Food', name:'', cat:'', price:0, available:true, __new:true });
      render();
      // no autosave here; wait for user to pick item/price or click Save
    });

    // Manual save
    $('save').addEventListener('click', saveToSheet);

    // Download JSON (backup)
    $('download').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(rows, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '1708-menu.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // Load JSON (write to sheet) — POST body, not URL
    $('upload').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      let arr = JSON.parse(text);
      if (!Array.isArray(arr)) { alert('JSON must be an array'); return; }
      $('status').textContent = 'Importing...';
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams({
          token: TOKEN,
          op: 'write',
          rows: JSON.stringify(arr)
        })
      });
      const data = await res.json();
      if(!data.ok){ alert(data.error||'Import failed'); $('status').textContent=''; return; }
      await fetchItems();
      $('status').textContent = `Imported ${data.count} item(s)`;
    });

    // Start fresh (2 rows) — POST body, not URL
    $('startfresh').addEventListener('click', async ()=>{
      if(!confirm('Replace the sheet with 2 starter rows?')) return;
      const seed = [
        { id:'seed-1', type:'Drinks', name:'Sample Drink', cat:'Whiskey', price:10000, available:true,  updatedAt:'' },
        { id:'seed-2', type:'Food',   name:'Sample Meal',  cat:'Main',    price: 5000, available:true,  updatedAt:'' }
      ];
      $('status').textContent='Starting fresh...';
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams({
          token: TOKEN,
          op: 'write',
          rows: JSON.stringify(seed)
        })
      });
      const data = await res.json();
      if(!data.ok){ alert(data.error||'Failed'); $('status').textContent=''; return; }
      await fetchItems();
      $('status').textContent = `Imported ${data.count} item(s)`;
    });

    // === SAVE (clean + dedupe before writing) ===
    async function saveToSheet(options = {}){
      const silent = !!options.silent;
      try{
        // merge rows + pendingNew
        const merged = rows.concat(
          pendingNew.map(x=>({
            id:x.id, type:x.type||'', name:x.name||'', cat:x.cat||'',
            price:Number(x.price||0), available:!!x.available, updatedAt:''
          }))
        );

        // drop incomplete rows (prevent blank Food/Drinks entries)
        const cleaned = merged.filter(r => r.type && r.name && r.cat);

        // de-duplicate by (type|cat|name), keep last occurrence
        const map = new Map();
        for (const r of cleaned){
          map.set(`${r.type}|||${r.cat}|||${r.name}`, r);
        }
        const finalRows = Array.from(map.values());

        const r = await fetch(API_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
          body: new URLSearchParams({
            token: TOKEN,
            op: 'write',
            rows: JSON.stringify(finalRows)
          })
        });

        const j = await r.json();
        if(!j.ok){
          $('status').textContent = 'Save failed';
          if (!silent) alert(j.error || 'Save failed');   // show server error reason
          return;
        }

        // sync UI immediately
        rows = finalRows;
        pendingNew = [];
        render();
        $('status').textContent = 'Saved ✓';
      }catch(err){
        $('status').textContent = 'Save failed';
        if (!silent) alert(err.message||err);
      }
    }

    $('search').addEventListener('input', render);
    $('show').addEventListener('change', render);

    // init
    fetchItems().catch(err=>alert(err.message||err));
  </script>
</body>
</html>
